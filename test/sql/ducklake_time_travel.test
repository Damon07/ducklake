# name: test/sql/ducklake_time_travel.test
# description: test time travel in ducklake
# group: [ducklake]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_time_travel.db' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_time_travel_files')

statement ok
CREATE TABLE ducklake.test(s STRUCT(i INTEGER, j INTEGER));

query I
SELECT * FROM ducklake.test
----

statement ok
INSERT INTO ducklake.test VALUES ({'i': 1, 'j': 2}), ({'i': NULL, 'j': 3}), (NULL);

# non-existent version
statement error
SELECT * FROM ducklake.test AT (VERSION => 10)
----
No snapshot found at version 10

# table does not exist
statement error
SELECT * FROM ducklake.test AT (VERSION => 0)
----
does not exist at version 0

query I
SELECT * FROM ducklake.test AT (VERSION => 1)
----

query I
SELECT * FROM ducklake.test AT (VERSION => 2)
----
{'i': 1, 'j': 2}
{'i': NULL, 'j': 3}
NULL

# timestamp-based query
query I
SELECT * FROM ducklake.test AT (TIMESTAMP => NOW())
----
{'i': 1, 'j': 2}
{'i': NULL, 'j': 3}
NULL

# read a dropped table
statement ok
DROP TABLE ducklake.test

statement error
SELECT * FROM ducklake.test
----
does not exist

query I
SELECT * FROM ducklake.test AT (VERSION => 2)
----
{'i': 1, 'j': 2}
{'i': NULL, 'j': 3}
NULL
