# name: test/sql/table_changes/ducklake_table_deletions.test
# description: test ducklake_table_deletions function
# group: [ducklake]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_table_deletions.db' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_table_deletions_files', METADATA_CATALOG 'xx')

# snapshot 1
statement ok
CREATE TABLE ducklake.test(i INTEGER);

# snapshot 2
statement ok
INSERT INTO ducklake.test VALUES (1)

# snapshot 3
statement ok
INSERT INTO ducklake.test VALUES (2)

# snapshot 4
statement ok
INSERT INTO ducklake.test VALUES (3)

# snapshot 5
statement ok
INSERT INTO ducklake.test VALUES (NULL)

# snapshot 6
statement ok
INSERT INTO ducklake.test FROM range(10, 15)

# snapshot 7
statement ok
DELETE FROM ducklake.test WHERE i=2

# snapshot 8
statement ok
DELETE FROM ducklake.test WHERE i=11

# snapshot 9
statement ok
DELETE FROM ducklake.test WHERE i=12

# snapshot 7 deleted i=2
query II
SELECT rowid, * FROM ducklake_table_deletions('ducklake', 'test', 7, 7);
----
1	2

# snapshot 8 deleted i=11
query II
SELECT rowid, * FROM ducklake_table_deletions('ducklake', 'test', 8, 8);
----
5	11

# snapshot 9 deleted i=12
query II
SELECT rowid, * FROM ducklake_table_deletions('ducklake', 'test', 9, 9);
----
6	12

# we can get all of these at once
query II
SELECT rowid, * FROM ducklake_table_deletions('ducklake', 'test', 7, 9) ORDER BY rowid
----
1	2
5	11
6	12

# if we start from no rows (snapshot 0) we have no deletions - because the table at snapshot 0 is empty
query II
SELECT rowid, * FROM ducklake_table_deletions('ducklake', 'test', 0, 9) ORDER BY rowid
----

# snapshot 10: update a subset of the rows
statement ok
UPDATE ducklake.test SET i=i+100 WHERE i < 13

# updates are deletions + insertions
query II
SELECT rowid, * FROM ducklake_table_deletions('ducklake', 'test', 10, 10) ORDER BY rowid
----
0	1
2	3
4	10

# these are all the deleted tuples
query II
SELECT rowid, * FROM ducklake_table_deletions('ducklake', 'test', 7, 10) ORDER BY rowid
----
0	1
1	2
2	3
4	10
5	11
6	12

# if we start from no rows (snapshot 0) we have no deletions
query II
SELECT rowid, * FROM ducklake_table_deletions('ducklake', 'test', 0, 10) ORDER BY rowid
----
