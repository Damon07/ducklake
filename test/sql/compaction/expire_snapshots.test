# name: test/sql/compaction/expire_snapshots.test
# description: test ducklake expiration of snapshots
# group: [ducklake]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_expire_snapshots.db' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_expire_snapshots_files', METADATA_CATALOG 'metadata')

# delete all values in a table
# snapshot 1
statement ok
CREATE TABLE ducklake.test(i INTEGER)

# snapshot 2
statement ok
INSERT INTO ducklake.test FROM range(1000)

# snapshot 3
statement ok
DELETE FROM ducklake.test

# snapshot 4
statement ok
DROP TABLE ducklake.test

# explicitly expire snapshot 2
statement ok
CALL ducklake_expire_snapshots('ducklake', versions => [2])

# the snapshot is no longer available
statement error
FROM ducklake.test AT (VERSION => 2)
----
No snapshot found at version 2

# we can query around that though
query I
FROM ducklake.test AT (VERSION => 1)
----

query I
FROM ducklake.test AT (VERSION => 3)
----

# the data file is no longer required (since only snapshot 2 references it) -> we can delete it now
query I
SELECT COUNT(*) FROM ducklake_cleanup_old_files('ducklake', dry_run => true, cleanup_all => true);
----
1

statement ok
CALL ducklake_cleanup_old_files('ducklake', cleanup_all => true);

# verify that it is actually gone
query I
SELECT COUNT(*) FROM GLOB('__TEST_DIR__/ducklake_expire_snapshots_files/*')
----
0

# let's delete snapshots 1/3
statement ok
CALL ducklake_expire_snapshots('ducklake', versions => [1, 3])

# all traces of the table are gone
query I
SELECT COUNT(*) FROM metadata.ducklake_table
----
0
