# name: test/sql/compaction/small_insert_compaction.test
# description: test ducklake compaction of consecutive small inserts
# group: [ducklake]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_compaction.db' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_compaction_files')

# FIXME:
statement ok
SET threads=1

statement ok
CREATE TABLE ducklake.test(i INTEGER);

statement ok
INSERT INTO ducklake.test VALUES (1);

statement ok
INSERT INTO ducklake.test VALUES (2);

statement ok
INSERT INTO ducklake.test VALUES (3);

statement ok
INSERT INTO ducklake.test VALUES (4);

statement ok
INSERT INTO ducklake.test VALUES (5);

query I
SELECT COUNT(*) FROM GLOB('__TEST_DIR__/ducklake_compaction_files/*')
----
5

query III
SELECT snapshot_id, rowid, * FROM ducklake.test ORDER BY ALL
----
2	0	1
3	1	2
4	2	3
5	3	4
6	4	5

statement ok
CALL ducklake_merge_adjacent_files('ducklake');

# statement ok
# CALL ducklake_cleanup_old_files(older_than => interval '0 days');

query I
SELECT * FROM ducklake.test AT (VERSION => 2)
----
1

query I
SELECT * FROM ducklake.test AT (VERSION => 3)
----
1
2

query III
SELECT snapshot_id, rowid, * FROM ducklake.test ORDER BY ALL
----
2	0	1
3	1	2
4	2	3
5	3	4
6	4	5

query I
SELECT COUNT(*) FROM GLOB('__TEST_DIR__/ducklake_compaction_files/*')
----
1
