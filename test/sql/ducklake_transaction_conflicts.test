# name: test/sql/ducklake_transaction_conflicts.test
# description: Test transaction conflicts in DuckLake
# group: [quack]

require ducklake

require parquet

statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake.db' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_files', METADATA_CATALOG 'ducklake_meta')

statement ok
SET immediate_transaction_mode=true

# two transactions try to create a table with different names: no conflict
statement ok con1
BEGIN

statement ok con2
BEGIN

statement ok con1
CREATE TABLE ducklake.test2(i INTEGER);

statement ok con2
CREATE TABLE ducklake.test3(s VARCHAR);

statement ok con1
COMMIT

statement ok con2
COMMIT

# two transactions try to create a table with the same name: conflict
statement ok con1
BEGIN

statement ok con2
BEGIN

statement ok con1
CREATE TABLE ducklake.test(i INTEGER);

statement ok con2
CREATE TABLE ducklake.test(s VARCHAR);

statement ok con1
COMMIT

statement error con2
COMMIT
----
zxcv

# two transactions try to insert into the same table: no conflict
statement ok con1
BEGIN

statement ok con2
BEGIN

statement ok con1
INSERT INTO ducklake.test VALUES (1);

statement ok con2
INSERT INTO ducklake.test VALUES (100);

statement ok con1
COMMIT

statement ok con2
COMMIT

# two transactions try to drop the same table: conflict
# two transactions try to create a schema with the same name: conflict
# two transactions try to create a table with the same name in a different schema: no conflict
# two transactions try to drop the same schema: conflict
# one transaction tries to create a table in a dropped schema: conflict
# one transaction tries to insert data in a dropped table: conflict