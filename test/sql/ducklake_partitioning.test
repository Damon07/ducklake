# name: test/sql/ducklake_partitioning.test
# description: Test partitioning
# group: [ducklake]

require ducklake

require parquet

# partitioning based on a column
statement ok
ATTACH 'ducklake:__TEST_DIR__/ducklake_partitioning.db' AS ducklake (DATA_PATH '__TEST_DIR__/ducklake_partitioning')

statement ok
USE ducklake

statement ok
CREATE TABLE partitioned_tbl(part_key INTEGER, values VARCHAR);

statement ok
ALTER TABLE partitioned_tbl SET PARTITIONED BY (part_key);

statement ok
INSERT INTO partitioned_tbl SELECT i%2, concat('thisisastring_', i) FROM range(10000) t(i)

query I
SELECT COUNT(*) FROM partitioned_tbl WHERE part_key=0
----
5000

# append to partition
statement ok
INSERT INTO partitioned_tbl SELECT (i%2) + 1, concat('thisisanotherstring_', i) FROM range(10000) t(i)

query I
SELECT COUNT(*) FROM partitioned_tbl WHERE part_key=2
----
5000

# set partition and append in the same transaction
statement ok
CREATE TABLE partition_tbl2(part_key INTEGER, values VARCHAR);

statement ok
BEGIN

statement ok
ALTER TABLE partition_tbl2 SET PARTITIONED BY (part_key);

statement ok
INSERT INTO partition_tbl2 SELECT i%2, concat('thisisastring_', i) FROM range(10000) t(i)

query I
SELECT COUNT(*) FROM partition_tbl2 WHERE part_key=0
----
5000

statement ok
COMMIT

query I
SELECT COUNT(*) FROM partition_tbl2 WHERE part_key=0
----
5000

# create table and set partition in the same transaction
# create table, set partition and append in the same transaction
# rename table and set partition in the same transaction
# verify partition is actually used (function?)